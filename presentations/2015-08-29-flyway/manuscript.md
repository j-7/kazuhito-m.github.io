# みうみうのFlyway体験記

2015/08/29 Hoge駆動な人々 - #Hogedriven

# 導入(思想と使い方)

## 抑えておきたい特徴

+ 基本CLIツール
+ Javaプログラムから呼び出すなど操作することも可能
+ 「任意のフォルダ」と「ファイル命名則」と「Mig対象DBに１つ特殊テーブル」を必要とする
+ 基本SQLがデフォだが「Javaプログラムでの操作」も書ける
+ 思想的に(つまりおそらく永久に)「ダウングレード」には未対応
  + 戻す操作があるのならフォワードで対応


## スクラップ

+ http://dev.classmethod.jp/tool/flyway-db-migration/
+ https://siguniang.wordpress.com/2013/11/10/db-schema-migration-made-easy-with-flyway/
+ http://qiita.com/opengl-8080/items/6368c19a06521b65a655
  + プログラムからの呼び方
+ http://tototoshi.hatenablog.com/entry/2015/01/27/234314
  + 複数人開発に向いてないんじゃないか問題
+ http://erudoru.hatenablog.com/entry/2013/11/26/002659
  + SQLじゃなくてJavaで書く方法

# 前提(今運用しているシステム)

+ 比較的「小さい」Webアプリ
  + リリースは「50mくらいのWar一本」
  + DBも「一分かからずダンプ取れる」ような軽いもの
    + ただし本運用してない
    + 段階的に範囲に利用者が三倍になる
    + メイントランザクションデータの「削除」が無いので貯まる一方
    + つまり「軽い」のは今だけ？
  + データはDBの他に「とある領域の画像ファイル」もアプリの持ち物
+ 最近「ご破産にして作りなおして」る
  + 外部仕様とDBは極力似せて
  + ソースは「極力旧から持ってこない」


# 運用

## 決めごと

+ ファイル命名則 : v[000]__[何かアクション]_[対象となるテーブルor抽象的な集合名].sql
  + 連番は最近000の三桁
    + 「ファイルが名前順に並んでくれない」は以外とストレスなんで…ご破算にする時に
  + アクションは単一ならCUDそうでなければ目的ベースのなまえみ
+ Webアプリ立ち上がり時に動くよう仕込んである
  + ローカル、ステージ、本番も皆同様
+ 「ロールバックな運用」(DDL,データともに)は出来ないししない
+ 基本、ミスがあっても「フォワードで直して」行く
+ 「トランザクションデータの修正」「超緊急の修正」以外は極力マイグレーションに寄せる
+ 一応「ローカル用」「ステージング環境用」など「ここに置けば環境限定で動作」という場所は設けてある
  + 作りこんだ(こまれてた)
  + 開発用環境だけ、ステージングだけ、かつ共有のような独特なものがあるため
  + 「環境限定」でもメインストリームと通し番号共有
  + もちろんながら「極力使わないように」

## リリース時

+ 開発->ステージング->本番と「かならず手順を踏んで」マイグレーションする

## 開発時

+ 各自がマイグレーションを使いたく成った時点で「この番号使うから！」宣言メール送る
  + Flywayに限らない一般論だが「マイグレーションのこの変更を無かったことにする」のはほぼ無理
  + 番号かぶりでコミットした場合も「どちらかの端末の変更を殺す必要があるのは変わらない
  + 「ファイルが存在した途端にVersionが進む(0行SQLが無事成功)」ので、「バージョンだけ予約しといてあとで実装」とかできない
  + 最悪ローカルで事故ってるうちはいいがpushしてしまうと事故が全端末に波及する
  + ので、このルール

## 利用のエピソード

+ イメージディレクトリの移動/大文字小文字リネームに「Java側機能」使う
+ 画面の無い(お客様が本番で変更しようのない)マスタテーブルのメンテナンス
うひｔ## データのライフサイクルがおしなべられることにより「DBにせんでもええデータ」が浮かび上がる
# なんとなく気づき
